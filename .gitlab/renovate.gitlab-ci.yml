# Renovate Bot Pipeline for GitLab.com Free Tier
# This pipeline runs Renovate to automatically update dependencies

.renovate:
  stage: renovate
  image:
    name: renovate/renovate:latest
    entrypoint: [""]
  only:
    - schedules
    - web
  script:
    - renovate --platform=gitlab --token=${RENOVATE_TOKEN} ${CI_PROJECT_PATH}

renovate:
  extends: .renovate
  variables:
    LOG_LEVEL: info
    RENOVATE_BASE_BRANCHES: ${CI_DEFAULT_BRANCH}
    RENOVATE_ONBOARDING: "false"
    RENOVATE_REQUIRE_CONFIG: "required"
    # Enable GitLab automerge
    RENOVATE_GIT_LAB_AUTOMERGE: "true"
    # GitLab-specific optimizations
    RENOVATE_OPTIMIZE_FOR_DISABLED: "true"
    RENOVATE_PR_FOOTER: "This MR has been generated by Renovate Bot"
  before_script:
    - echo "Starting Renovate Bot..."
    - echo "Repository: ${CI_PROJECT_PATH}"
    - echo "Base Branch: ${CI_DEFAULT_BRANCH}"
  after_script:
    - echo "Renovate Bot completed"
  artifacts:
    reports:
      dotenv: renovate-env.txt
    when: always
    expire_in: 7 days
  allow_failure: true
  rules:
    # Run on scheduled pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: on_success
    # Allow manual trigger from GitLab UI
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: on_success
    # Never run on merge request pipelines
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never

# Dry-run job for testing Renovate configuration
renovate:dry-run:
  extends: .renovate
  variables:
    LOG_LEVEL: debug
    RENOVATE_DRY_RUN: "full"
    RENOVATE_ONBOARDING: "false"
    RENOVATE_REQUIRE_CONFIG: "required"
  script:
    - renovate --platform=gitlab --token=${RENOVATE_TOKEN} ${CI_PROJECT_PATH} --dry-run=full
  rules:
    # Only run manually from branches containing 'renovate' in the name
    - if: '$CI_COMMIT_BRANCH =~ /renovate/ && $CI_PIPELINE_SOURCE == "web"'
      when: manual
  allow_failure: true
